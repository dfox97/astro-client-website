<button class="nav-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
  <span class="hamburger"></span>
</button>

<nav class="nav" role="navigation" aria-label="Main navigation">
  <a href="/">Home</a>
  <div class="nav-item">
    <a href="/about" class="nav-link-with-dropdown">About</a>
    <div class="nav-dropdown">
      <a href="/about/who-are-we">Who Are We</a>
      <a href="/about/certifications">Certifications</a>
    </div>
  </div>
  <a href="/services">Services</a>
  <a href="/projects">Projects</a>
  <a href="/#contact">Contact</a>
</nav>

<script>
// Mobile nav toggle
const toggle = document.querySelector('.nav-toggle') as HTMLButtonElement | null;
const nav = document.querySelector('.nav');

if (toggle && nav) {
  toggle.addEventListener('click', () => {
    const expanded = toggle.getAttribute('aria-expanded') === 'true';
    toggle.setAttribute('aria-expanded', String(!expanded));
    nav.classList.toggle('show');
  });

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    const target = e.target as Node | null;
    if (
      nav.classList.contains('show') &&
      target &&
      !nav.contains(target) &&
      !toggle.contains(target)
    ) {
      nav.classList.remove('show');
      toggle.setAttribute('aria-expanded', 'false');
    }
  });

  // Close menu on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && nav.classList.contains('show')) {
      nav.classList.remove('show');
      toggle.setAttribute('aria-expanded', 'false');
      toggle.focus();
    }
  });
}

// Mobile dropdwon smooth animation
const navItems = document.querySelectorAll('.nav-item');
navItems.forEach((item) => {
  const link = item.querySelector('.nav-link-with-dropdown') as HTMLAnchorElement | null;
  const dropdown = item.querySelector('.nav-dropdown') as HTMLElement | null;
  if (!link || !dropdown) return;

  const dropdownLinks = dropdown ? Array.from(dropdown.querySelectorAll('a')) : [];
  let currentFocusIndex = -1;
  link.addEventListener('keydown', (e) => {
    if (window.innerWidth < 1024) return;

    if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      if (dropdownLinks.length > 0) {
        currentFocusIndex = 0;
        dropdownLinks[0].focus();
      }
    }
  });

// Desktop dropdown keyboard navigation
  dropdownLinks.forEach((link, index) => {
    link.addEventListener('keydown', (e) => {
      if (window.innerWidth < 1024) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentFocusIndex = (index + 1) % dropdownLinks.length;
        dropdownLinks[currentFocusIndex].focus();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (index === 0) {
          link.focus();
          currentFocusIndex = -1;
        } else {
          currentFocusIndex = index - 1;
          dropdownLinks[currentFocusIndex].focus();
        }
      } else if (e.key === 'Escape') {
        e.preventDefault();
        link.focus();
        currentFocusIndex = -1;
      }
    });
  });
  
  if (link && dropdown) {
     link.addEventListener('click', (e) => {
      if (window.innerWidth < 1024) {
        e.preventDefault();

        const isOpen = item.classList.contains('mobile-open');

        document.querySelectorAll('.nav-item').forEach(otherItem => {
          if (otherItem !== item && otherItem.classList.contains('mobile-open')) {
            const otherDropdown = otherItem.querySelector('.nav-dropdown') as HTMLElement | null;
            otherItem.classList.remove('mobile-open');
            if (otherDropdown) {
              otherDropdown.style.maxHeight = '0px';
            }
          }
        });

        if (!isOpen) {
          item.classList.add('mobile-open');
          dropdown.style.maxHeight = dropdown.scrollHeight + 'px';
        } else {
          item.classList.remove('mobile-open');
          dropdown.style.maxHeight = '0px';
        }
      }
    });
  }
});

</script>
